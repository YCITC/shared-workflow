name: Gemini AI Code Review

on:
  workflow_call:
    inputs:
      pull_request_json:
        required: true
        type: string
      repo_owner:
        required: true
        type: string
      repo_name:
        required: true
        type: string
    secrets:
      GEMINI_API_KEY:
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Pull Request JSON
        id: parse_pr
        run: |
          echo "pull_request=$(echo '${{ inputs.pull_request_json }}' | jq -c .)" >> $GITHUB_OUTPUT
        shell: bash

      - name: Get PR Diff and Save to File
        id: get_diff
        run: |
          set -eo pipefail
          PR_JSON='${{ steps.parse_pr.outputs.pull_request }}'
          BASE_SHA=$(echo $PR_JSON | jq -r '.base.sha')
          HEAD_SHA=$(echo $PR_JSON | jq -r '.head.sha')
          
          # Ensure BASE_SHA and HEAD_SHA are not empty
          if [ -z "$BASE_SHA" ] || [ -z "$HEAD_SHA" ]; then
            echo "Error: BASE_SHA or HEAD_SHA is empty. Cannot get diff."
            exit 1
          fi

          DIFF_CONTENT=$(git diff $BASE_SHA $HEAD_SHA)

          if [ -z "$DIFF_CONTENT" ]; then
            echo "is_empty=true" >> $GITHUB_OUTPUT
          else
            echo "is_empty=false" >> $GITHUB_OUTPUT
                # Get diff excluding test files, lock files, and generated files
                # Use || [ $? -eq 141 ] to ignore SIGPIPE errors caused by head -n 1000
                (git diff $BASE_SHA $HEAD_SHA -- \
                  ':!*.test.*' ':!*.spec.*' ':!*_test.py' ':!test_*.py' \
                  ':!package-lock.json' ':!yarn.lock' ':!pnpm-lock.yaml' \
                  ':!*.min.js' ':!*.min.css' ':!*.map' \
                  | head -n 1000 > pr_diff.txt) || [ $? -eq 141 ]
              fi
      - name: Run AI Code Review Script
        id: gemini_review
        if: steps.get_diff.outputs.is_empty == 'false'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -eo pipefail
          pip install requests
          output_file=$(mktemp)
          # Execute the script, teeing its output to both the log and the temp file.
          # The exit code of the python script is captured via PIPESTATUS, not the exit code of tee.
          python .github/scripts/review.py 2>&1 | tee "$output_file"
          exit_code=${PIPESTATUS[0]}
          # Now, handle the output and exit code
          output=$(<"$output_file")
          echo "review_comment<<EOF" >> $GITHUB_OUTPUT
          echo "$output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          if [ $exit_code -ne 0 ]; then
            echo "Error: Python script failed with exit code $exit_code"
            # The output is already visible in the log because of tee, but we can print it again for clarity.
            echo "Script output was:"
            echo "$output"
            exit $exit_code
          fi

      - name: Post Review Comment to PR
        if: steps.gemini_review.outputs.review_comment != ''
        uses: actions/github-script@v7
        env:
          # å°‡ review å…§å®¹è¨­å®šç‚ºä¸€å€‹ç’°å¢ƒè®Šæ•¸
          REVIEW_COMMENT: ${{ steps.gemini_review.outputs.review_comment }}
        with:
          script: |
            // å¾ç’°å¢ƒè®Šæ•¸ä¸­å®‰å…¨åœ°è®€å–ç•™è¨€å…§å®¹
            const comment = process.env.REVIEW_COMMENT;
            
            const review_body = `### ğŸ¤– Gemini AI Code Review\n\n${comment}`;
            
            github.rest.issues.createComment({
              owner: '${{ inputs.repo_owner }}',
              repo: '${{ inputs.repo_name }}',
              issue_number: JSON.parse('${{ inputs.pull_request_json }}').number,
              body: review_body
            });
